{% extends 'base.html' %}
{% block content %}
<!-- Header Section -->
<div class="row mb-4">
	<div class="col-12">
		<div class="d-flex justify-content-between align-items-center">
			<div>
				<h1 class="text-gradient mb-2">
					<i class="fas fa-play-circle text-info me-2"></i>
					Session Replay
				</h1>
				<p class="text-muted mb-0">Interactive session playback and attack flow visualization</p>
			</div>
			<div class="d-flex align-items-center gap-3">
				<span class="badge bg-info">
					<i class="fas fa-video me-1"></i>Live Sessions
				</span>
				<button class="btn btn-primary" id="refresh-sessions">
					<i class="fas fa-sync-alt me-1"></i>Refresh
				</button>
				<button class="btn btn-outline-secondary" onclick="exportSessions()">
					<i class="fas fa-download me-1"></i>Export
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Session Statistics -->
<div class="row g-3 mb-4">
	<div class="col-12 col-md-3">
		<div class="card text-center animate-fade-in">
			<div class="card-body">
				<i class="fas fa-play text-primary fa-2x mb-2"></i>
				<h4 class="text-primary mb-1" id="active-sessions">-</h4>
				<small class="text-muted">Active Sessions</small>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.1s;">
			<div class="card-body">
				<i class="fas fa-clock text-info fa-2x mb-2"></i>
				<h4 class="text-info mb-1" id="avg-duration">-</h4>
				<small class="text-muted">Avg Duration</small>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.2s;">
			<div class="card-body">
				<i class="fas fa-terminal text-warning fa-2x mb-2"></i>
				<h4 class="text-warning mb-1" id="total-commands">-</h4>
				<small class="text-muted">Total Commands</small>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.3s;">
			<div class="card-body">
				<i class="fas fa-exclamation-triangle text-danger fa-2x mb-2"></i>
				<h4 class="text-danger mb-1" id="high-risk-sessions">-</h4>
				<small class="text-muted">High Risk</small>
			</div>
		</div>
	</div>
</div>

<!-- Main Content Row -->
<div class="row g-4">
	<!-- Session List -->
	<div class="col-12 col-lg-4">
		<div class="card animate-fade-in" style="animation-delay: 0.4s;">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">
					<i class="fas fa-list text-primary me-2"></i>
					Active Sessions
				</h5>
				<span class="badge bg-primary" id="session-count">0</span>
			</div>
			<div class="card-body">
				<div id="sessions-list">
					<div class="text-center py-3">
						<div class="spinner-border spinner-border-sm text-primary" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<p class="mt-2 text-muted small">Loading sessions...</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Session Timeline -->
	<div class="col-12 col-lg-8">
		<div class="card animate-fade-in" style="animation-delay: 0.5s;">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">
					<i class="fas fa-timeline text-info me-2"></i>
					Session Timeline
				</h5>
				<div class="d-flex gap-2">
					<button class="btn btn-sm btn-outline-secondary" onclick="playSession()">
						<i class="fas fa-play me-1"></i>Play
					</button>
					<button class="btn btn-sm btn-outline-secondary" onclick="pauseSession()">
						<i class="fas fa-pause me-1"></i>Pause
					</button>
				</div>
			</div>
			<div class="card-body">
				<div id="session-timeline">
					<div class="text-center py-5">
						<i class="fas fa-mouse-pointer text-muted fa-3x mb-3"></i>
						<p class="text-muted">Select a session to view timeline</p>
						<small class="text-muted">Click on any session from the list to start replay</small>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Attack Flow Visualization -->
<div class="row mt-4">
	<div class="col-12">
		<div class="card animate-fade-in" style="animation-delay: 0.6s;">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">
					<i class="fas fa-project-diagram text-warning me-2"></i>
					Attack Flow Visualization
				</h5>
				<div class="d-flex gap-2">
					<button class="btn btn-sm btn-outline-secondary" onclick="resetFlow()">
						<i class="fas fa-undo me-1"></i>Reset
					</button>
					<button class="btn btn-sm btn-outline-secondary" onclick="exportFlow()">
						<i class="fas fa-download me-1"></i>Export
					</button>
				</div>
			</div>
			<div class="card-body p-0">
				<div id="attack-flow" style="height: 500px; border-radius: 0 0 1rem 1rem;">
					<div class="text-center py-5">
						<i class="fas fa-network-wired text-muted fa-3x mb-3"></i>
						<p class="text-muted">Select a session to view attack flow</p>
						<small class="text-muted">Interactive network visualization of attack patterns</small>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Command Analysis Modal -->
<div class="modal fade" id="commandModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content bg-dark">
			<div class="modal-header border-secondary">
				<h5 class="modal-title">
					<i class="fas fa-terminal text-warning me-2"></i>
					Command Analysis
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div id="command-analysis-content">
					<div class="text-center py-3">
						<div class="spinner-border spinner-border-sm text-primary" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<p class="mt-2 text-muted small">Loading command analysis...</p>
					</div>
				</div>
			</div>
			<div class="modal-footer border-secondary">
				<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
					<i class="fas fa-times me-1"></i>Close
				</button>
				<button type="button" class="btn btn-primary" onclick="exportCommand()">
					<i class="fas fa-download me-1"></i>Export
				</button>
			</div>
		</div>
	</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css" rel="stylesheet">

<script>
(function(){
	'use strict';
	
	let currentSessionId = null;
	let network = null;
	let isPlaying = false;
	
	function qs(id){ return document.getElementById(id); }
	
	function updateSessionStats(sessions) {
		const activeCount = sessions.length;
		qs('active-sessions').textContent = activeCount;
		qs('session-count').textContent = activeCount;
		
		if (activeCount === 0) {
			qs('avg-duration').textContent = '0m';
			qs('total-commands').textContent = '0';
			qs('high-risk-sessions').textContent = '0';
			return;
		}
		
		// Calculate average duration
		const totalDuration = sessions.reduce((sum, session) => {
			const start = new Date(session.start_time);
			const end = new Date(session.end_time);
			return sum + (end - start);
		}, 0);
		const avgDuration = Math.round(totalDuration / activeCount / 60000); // minutes
		qs('avg-duration').textContent = `${avgDuration}m`;
		
		// Calculate total commands
		const totalCommands = sessions.reduce((sum, session) => sum + (session.event_count || 0), 0);
		qs('total-commands').textContent = totalCommands;
		
		// Calculate high risk sessions (sessions with high threat scores)
		const highRiskCount = sessions.filter(session => (session.threat_score || 0) > 70).length;
		qs('high-risk-sessions').textContent = highRiskCount;
	}
	
	async function loadSessions() {
		try {
			const response = await fetch('/api/sessions');
			const data = await response.json();
			const container = qs('sessions-list');
			const sessions = data.sessions || [];
			
			updateSessionStats(sessions);
			
			if (sessions.length === 0) {
				container.innerHTML = `
					<div class="text-center py-4">
						<i class="fas fa-inbox text-muted fa-2x mb-2"></i>
						<p class="text-muted mb-0">No active sessions found</p>
						<small class="text-muted">Sessions will appear here when detected</small>
					</div>
				`;
				return;
			}
			
			container.innerHTML = sessions.map(session => `
				<div class="session-item mb-2 p-3 border border-secondary rounded cursor-pointer session-card" 
					 onclick="loadSession('${session.session_id}')" 
					 style="cursor: pointer; transition: all 0.2s ease;">
					<div class="d-flex justify-content-between align-items-start mb-2">
						<div class="d-flex align-items-center">
							<i class="fas fa-play-circle text-primary me-2"></i>
							<strong class="font-monospace">${session.session_id.substring(0, 12)}...</strong>
						</div>
						<span class="badge bg-${(session.threat_score || 0) > 70 ? 'danger' : (session.threat_score || 0) > 40 ? 'warning' : 'success'}">
							${session.event_count} events
						</span>
					</div>
					<div class="small text-muted">
						<div class="d-flex justify-content-between">
							<span><i class="fas fa-globe me-1"></i>${session.attacker_ip || 'Unknown'}</span>
							<span><i class="fas fa-clock me-1"></i>${formatDuration(session.start_time, session.end_time)}</span>
						</div>
						${session.threat_score ? `<div class="mt-1"><i class="fas fa-shield-alt me-1"></i>Threat Score: ${session.threat_score}</div>` : ''}
					</div>
				</div>
			`).join('');
			
			// Add hover effects
			document.querySelectorAll('.session-card').forEach(card => {
				card.addEventListener('mouseenter', function() {
					this.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
					this.style.borderColor = 'rgba(13, 110, 253, 0.5)';
				});
				card.addEventListener('mouseleave', function() {
					this.style.backgroundColor = '';
					this.style.borderColor = '';
				});
			});
			
		} catch (error) {
			console.error('Error loading sessions:', error);
			qs('sessions-list').innerHTML = `
				<div class="alert alert-danger">
					<i class="fas fa-exclamation-triangle me-2"></i>
					Error loading sessions: ${error.message}
				</div>
			`;
		}
	}
	
	async function loadSession(sessionId) {
		currentSessionId = sessionId;
		
		// Update selected session visual
		document.querySelectorAll('.session-card').forEach(card => {
			card.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
		});
		
		const selectedCard = document.querySelector(`[onclick="loadSession('${sessionId}')"]`);
		if (selectedCard) {
			selectedCard.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
		}
		
		try {
			// Load timeline
			const response = await fetch(`/api/session/${sessionId}`);
			const data = await response.json();
			
			if (data.error) {
				qs('session-timeline').innerHTML = `
					<div class="alert alert-danger">
						<i class="fas fa-exclamation-triangle me-2"></i>
						${data.error}
					</div>
				`;
				return;
			}
			
			const session = data.sessions[0];
			renderTimeline(session);
			
			// Load attack flow
			loadAttackFlow(sessionId);
			
			if (typeof showNotification === 'function') {
				showNotification(`Session ${sessionId.substring(0, 8)}... loaded`, 'success', 2000);
			}
			
		} catch (error) {
			console.error('Error loading session:', error);
			qs('session-timeline').innerHTML = `
				<div class="alert alert-danger">
					<i class="fas fa-exclamation-triangle me-2"></i>
					Error loading session: ${error.message}
				</div>
			`;
		}
	}
	
	function renderTimeline(session) {
		const container = qs('session-timeline');
		
		let html = `
			<div class="mb-3">
				<h6>Session: <code>${session.session_id}</code></h6>
				<p class="text-muted">
					IP: ${session.attacker_ip || 'Unknown'} | 
					Events: ${session.total_events} | 
					Duration: ${formatDuration(session.start_time, session.end_time)}
				</p>
			</div>
		`;
		
		if (session.timeline && session.timeline.length > 0) {
			html += '<div class="timeline">';
			session.timeline.forEach((event, index) => {
				const threatClass = event.analysis ? getThreatClass(event.analysis.threat_level) : '';
				html += `
					<div class="timeline-item mb-2 p-2 border-start border-3 ${threatClass}">
						<div class="d-flex justify-content-between align-items-start">
							<div class="flex-grow-1">
								<small class="text-muted">${formatTime(event.timestamp)}</small>
								<div class="mt-1">
									<strong>${event.event_type || 'Unknown'}</strong>
									${event.username ? ` | User: <code>${event.username}</code>` : ''}
									${event.password ? ` | Pass: <code>${event.password}</code>` : ''}
								</div>
								${event.command ? `
									<div class="mt-1">
										<code class="text-warning">${event.command}</code>
										<button class="btn btn-sm btn-outline-info ms-2" onclick="analyzeCommand('${event.command.replace(/'/g, "\\'")}', '${event.analysis ? JSON.stringify(event.analysis).replace(/'/g, "\\'") : ''}')">
											Analyze
										</button>
									</div>
								` : ''}
							</div>
							${event.analysis ? `
								<span class="badge bg-${getThreatBadge(event.analysis.threat_level)} ms-2">
									${event.analysis.threat_level}
								</span>
							` : ''}
						</div>
					</div>
				`;
			});
			html += '</div>';
		} else {
			html += '<p class="text-muted">No timeline data available</p>';
		}
		
		container.innerHTML = html;
	}
	
	function loadAttackFlow(sessionId) {
		fetch(`/api/session/${sessionId}/flow`).then(r => r.json()).then(data => {
			if (data.error) {
				qs('attack-flow').innerHTML = `<p class="text-center text-danger mt-5">${data.error}</p>`;
				return;
			}
			
			renderAttackFlow(data);
		});
	}
	
	function renderAttackFlow(flowData) {
		const container = qs('attack-flow');
		
		if (!flowData.nodes || flowData.nodes.length === 0) {
			container.innerHTML = '<p class="text-center text-muted mt-5">No attack flow data available</p>';
			return;
		}
		
		// Clear previous network
		if (network) {
			network.destroy();
		}
		
		// Create nodes
		const nodes = new vis.DataSet(flowData.nodes.map(node => ({
			id: node.id,
			label: node.label,
			title: `${node.full_command}\nPurpose: ${node.purpose}\nThreat: ${node.threat_level}`,
			color: getThreatColor(node.threat_level),
			borderWidth: 2,
			shape: 'box',
			font: { color: '#ffffff' }
		})));
		
		// Create edges
		const edges = new vis.DataSet(flowData.edges.map(edge => ({
			from: edge.from,
			to: edge.to,
			label: edge.label,
			arrows: 'to',
			color: '#666666',
			font: { color: '#ffffff', size: 10 }
		})));
		
		// Network options
		const options = {
			nodes: {
				shape: 'box',
				margin: 10,
				shadow: true
			},
			edges: {
				width: 2,
				smooth: {
					type: 'cubicBezier',
					forceDirection: 'horizontal'
				}
			},
			layout: {
				hierarchical: {
					direction: 'LR',
					sortMethod: 'directed',
					nodeSpacing: 150,
					levelSeparation: 100
				}
			},
			physics: false
		};
		
		// Create network
		network = new vis.Network(container, { nodes, edges }, options);
		
		// Add click handler for nodes
		network.on('click', function(params) {
			if (params.nodes.length > 0) {
				const nodeId = params.nodes[0];
				const node = flowData.nodes.find(n => n.id === nodeId);
				if (node) {
					analyzeCommand(node.full_command, JSON.stringify({
						purpose: node.purpose,
						threat_level: node.threat_level,
						description: 'Command from attack flow'
					}));
				}
			}
		});
	}
	
	// Global functions
	window.loadSession = loadSession;
	
	window.analyzeCommand = function(command, analysis) {
		const modal = new bootstrap.Modal(qs('commandModal'));
		const content = qs('command-analysis-content');
		
		let analysisObj = {};
		try {
			analysisObj = JSON.parse(analysis);
		} catch (e) {
			analysisObj = {};
		}
		
		content.innerHTML = `
			<div class="mb-4">
				<h6 class="text-warning mb-2">
					<i class="fas fa-terminal me-2"></i>Command
				</h6>
				<div class="bg-dark p-3 rounded border">
					<code class="text-warning font-monospace">${command}</code>
				</div>
			</div>
			<div class="row g-3">
				<div class="col-md-4">
					<div class="card bg-transparent border-info">
						<div class="card-body text-center">
							<h6 class="text-info">Purpose</h6>
							<span class="badge bg-info fs-6">${analysisObj.purpose || 'Unknown'}</span>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="card bg-transparent border-warning">
						<div class="card-body text-center">
							<h6 class="text-warning">Threat Level</h6>
							<span class="badge bg-${getThreatBadge(analysisObj.threat_level || 'Unknown')} fs-6">${analysisObj.threat_level || 'Unknown'}</span>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="card bg-transparent border-secondary">
						<div class="card-body text-center">
							<h6 class="text-secondary">Risk Score</h6>
							<span class="badge bg-secondary fs-6">${analysisObj.risk_score || 'N/A'}</span>
						</div>
					</div>
				</div>
			</div>
			<div class="mt-4">
				<h6 class="text-muted mb-2">Description</h6>
				<p class="text-muted">${analysisObj.description || 'No description available'}</p>
			</div>
		`;
		
		modal.show();
	};
	
	window.playSession = function() {
		if (typeof showNotification === 'function') {
			showNotification('Session playback started', 'info', 2000);
		}
		isPlaying = true;
	};
	
	window.pauseSession = function() {
		if (typeof showNotification === 'function') {
			showNotification('Session playback paused', 'warning', 2000);
		}
		isPlaying = false;
	};
	
	window.resetFlow = function() {
		if (network) {
			network.destroy();
			network = null;
		}
		qs('attack-flow').innerHTML = `
			<div class="text-center py-5">
				<i class="fas fa-network-wired text-muted fa-3x mb-3"></i>
				<p class="text-muted">Attack flow reset</p>
				<small class="text-muted">Select a session to view attack flow</small>
			</div>
		`;
		if (typeof showNotification === 'function') {
			showNotification('Attack flow reset', 'info', 2000);
		}
	};
	
	window.exportFlow = function() {
		if (typeof showNotification === 'function') {
			showNotification('Exporting attack flow...', 'info', 3000);
		}
	};
	
	window.exportSessions = function() {
		if (typeof showNotification === 'function') {
			showNotification('Exporting session data...', 'info', 3000);
		}
	};
	
	window.exportCommand = function() {
		if (typeof showNotification === 'function') {
			showNotification('Exporting command analysis...', 'info', 3000);
		}
	};
	
	// Utility functions
	function formatTime(timestamp) {
		return new Date(timestamp).toLocaleString();
	}
	
	function formatDuration(start, end) {
		const startTime = new Date(start);
		const endTime = new Date(end);
		const diff = endTime - startTime;
		const minutes = Math.floor(diff / 60000);
		const seconds = Math.floor((diff % 60000) / 1000);
		return `${minutes}m ${seconds}s`;
	}
	
	function getThreatClass(threatLevel) {
		switch(threatLevel?.toLowerCase()) {
			case 'high': return 'border-danger';
			case 'medium': return 'border-warning';
			case 'low': return 'border-success';
			default: return 'border-secondary';
		}
	}
	
	function getThreatBadge(threatLevel) {
		switch(threatLevel?.toLowerCase()) {
			case 'high': return 'danger';
			case 'medium': return 'warning';
			case 'low': return 'success';
			default: return 'secondary';
		}
	}
	
	function getThreatColor(threatLevel) {
		switch(threatLevel?.toLowerCase()) {
			case 'high': return '#dc3545';
			case 'medium': return '#ffc107';
			case 'low': return '#28a745';
			default: return '#6c757d';
		}
	}
	
	// Event listeners
	qs('refresh-sessions').addEventListener('click', loadSessions);
	
	// Initial load
	loadSessions();
	
	// Auto-refresh every 30 seconds
	setInterval(loadSessions, 30000);
})();
</script>

<style>
.timeline-item {
	transition: all 0.2s ease;
}
.timeline-item:hover {
	background-color: rgba(255,255,255,0.1);
}
.session-item:hover {
	background-color: rgba(255,255,255,0.1);
}
.cursor-pointer {
	cursor: pointer;
}
</style>
{% endblock %}
