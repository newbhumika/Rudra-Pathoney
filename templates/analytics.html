{% extends 'base.html' %}
{% block content %}
<!-- Header Section -->
<div class="row mb-4">
	<div class="col-12">
		<div class="d-flex justify-content-between align-items-center">
			<div>
				<h1 class="text-gradient mb-2">
					<i class="fas fa-chart-bar text-primary me-2"></i>
					Security Analytics
				</h1>
				<p class="text-muted mb-0">Comprehensive analysis of attack patterns, trends, and threat intelligence</p>
			</div>
			<div class="d-flex align-items-center gap-3">
				<div class="dropdown">
					<select class="form-select" id="analytics-hours">
						<option value="1">Last 1 hour</option>
						<option value="6">Last 6 hours</option>
						<option value="24" selected>Last 24 hours</option>
						<option value="168">Last 7 days</option>
						<option value="720">Last 30 days</option>
						<option value="">All time</option>
					</select>
				</div>
				<button class="btn btn-primary" id="refresh-analytics">
					<i class="fas fa-sync-alt me-1"></i>Refresh
				</button>
				<button class="btn btn-outline-secondary" onclick="exportAnalytics()">
					<i class="fas fa-download me-1"></i>Export
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Key Performance Indicators -->
<div class="row g-4 mb-4">
	<div class="col-12 col-md-6 col-lg-3">
		<div class="card text-center animate-fade-in">
			<div class="card-body">
				<div class="d-flex align-items-center justify-content-center mb-3">
					<div class="bg-danger bg-opacity-10 rounded-circle p-3 me-3">
						<i class="fas fa-fire text-danger fa-2x"></i>
					</div>
					<div>
						<h3 class="mb-0 text-danger" id="attack-rate">--</h3>
						<small class="text-muted">Attacks/Hour</small>
					</div>
				</div>
				<div class="progress" style="height: 6px;">
					<div class="progress-bar bg-danger" role="progressbar" style="width: 85%"></div>
				</div>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-6 col-lg-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.1s;">
			<div class="card-body">
				<div class="d-flex align-items-center justify-content-center mb-3">
					<div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
						<i class="fas fa-globe text-warning fa-2x"></i>
					</div>
					<div>
						<h3 class="mb-0 text-warning" id="geographic-spread">--</h3>
						<small class="text-muted">Countries</small>
					</div>
				</div>
				<div class="progress" style="height: 6px;">
					<div class="progress-bar bg-warning" role="progressbar" style="width: 60%"></div>
				</div>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-6 col-lg-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.2s;">
			<div class="card-body">
				<div class="d-flex align-items-center justify-content-center mb-3">
					<div class="bg-info bg-opacity-10 rounded-circle p-3 me-3">
						<i class="fas fa-shield-alt text-info fa-2x"></i>
					</div>
					<div>
						<h3 class="mb-0 text-info" id="threat-level">--</h3>
						<small class="text-muted">Threat Level</small>
					</div>
				</div>
				<div class="progress" style="height: 6px;">
					<div class="progress-bar bg-info" role="progressbar" style="width: 75%"></div>
				</div>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-6 col-lg-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.3s;">
			<div class="card-body">
				<div class="d-flex align-items-center justify-content-center mb-3">
					<div class="bg-success bg-opacity-10 rounded-circle p-3 me-3">
						<i class="fas fa-check-circle text-success fa-2x"></i>
					</div>
					<div>
						<h3 class="mb-0 text-success" id="detection-rate">--</h3>
						<small class="text-muted">Detection Rate</small>
					</div>
				</div>
				<div class="progress" style="height: 6px;">
					<div class="progress-bar bg-success" role="progressbar" style="width: 95%"></div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Main Analytics Charts -->
<div class="row g-4 mb-4">
	<div class="col-12 col-lg-8">
		<div class="card h-100 animate-slide-in">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">
					<i class="fas fa-chart-line text-success me-2"></i>
					Attack Timeline Analysis
				</h5>
				<div class="btn-group btn-group-sm" role="group">
					<button type="button" class="btn btn-outline-secondary active" onclick="changeChartType('line')">Line</button>
					<button type="button" class="btn btn-outline-secondary" onclick="changeChartType('bar')">Bar</button>
					<button type="button" class="btn btn-outline-secondary" onclick="changeChartType('area')">Area</button>
				</div>
			</div>
			<div class="card-body">
				<div class="chart-container" style="height: 400px;">
					<canvas id="chartAttempts"></canvas>
				</div>
			</div>
		</div>
	</div>
	<div class="col-12 col-lg-4">
		<div class="card h-100 animate-slide-in" style="animation-delay: 0.1s;">
			<div class="card-header">
				<h5 class="mb-0">
					<i class="fas fa-chart-pie text-warning me-2"></i>
					Attack Distribution
				</h5>
			</div>
			<div class="card-body">
				<div class="chart-container" style="height: 300px;">
					<canvas id="chartAttackTypes"></canvas>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Detailed Analytics Row -->
<div class="row g-4 mb-4">
	<div class="col-12 col-lg-6">
		<div class="card animate-fade-in" style="animation-delay: 0.2s;">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">
					<i class="fas fa-chart-bar text-primary me-2"></i>
					Top Attacker IPs
				</h5>
				<span class="badge bg-primary">Top 10</span>
			</div>
			<div class="card-body">
				<div class="chart-container" style="height: 350px;">
					<canvas id="chartTopIPs"></canvas>
				</div>
			</div>
		</div>
	</div>
	<div class="col-12 col-lg-6">
		<div class="card animate-fade-in" style="animation-delay: 0.3s;">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">
					<i class="fas fa-key text-danger me-2"></i>
					Credential Analysis
				</h5>
				<span class="badge bg-danger">High Risk</span>
			</div>
			<div class="card-body">
				<div class="chart-container" style="height: 350px;">
					<canvas id="chartCreds"></canvas>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Geographic and Command Analysis -->
<div class="row g-4 mb-4">
	<div class="col-12 col-lg-6">
		<div class="card animate-fade-in" style="animation-delay: 0.4s;">
			<div class="card-header">
				<h5 class="mb-0">
					<i class="fas fa-globe text-info me-2"></i>
					Geographic Distribution
				</h5>
			</div>
			<div class="card-body">
				<div class="chart-container" style="height: 300px;">
					<canvas id="chartGeo"></canvas>
				</div>
			</div>
		</div>
	</div>
	<div class="col-12 col-lg-6">
		<div class="card animate-fade-in" style="animation-delay: 0.5s;">
			<div class="card-header">
				<h5 class="mb-0">
					<i class="fas fa-terminal text-warning me-2"></i>
					Command Frequency
				</h5>
			</div>
			<div class="card-body">
				<div class="chart-container" style="height: 300px;">
					<canvas id="chartCommands"></canvas>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Advanced Analytics Panel -->
<div class="row">
	<div class="col-12">
		<div class="card animate-fade-in" style="animation-delay: 0.6s;">
			<div class="card-header">
				<h5 class="mb-0">
					<i class="fas fa-brain text-warning me-2"></i>
					Advanced Analytics & Insights
				</h5>
			</div>
			<div class="card-body">
				<div class="row g-4">
					<div class="col-12 col-md-4">
						<div class="alert alert-info">
							<h6 class="alert-heading">
								<i class="fas fa-trending-up me-1"></i>
								Trend Analysis
							</h6>
							<div id="trend-analysis">
								<small class="text-muted">Analyzing attack trends...</small>
							</div>
						</div>
					</div>
					<div class="col-12 col-md-4">
						<div class="alert alert-warning">
							<h6 class="alert-heading">
								<i class="fas fa-exclamation-triangle me-1"></i>
								Anomaly Detection
							</h6>
							<div id="anomaly-detection">
								<small class="text-muted">Detecting anomalies...</small>
							</div>
						</div>
					</div>
					<div class="col-12 col-md-4">
						<div class="alert alert-success">
							<h6 class="alert-heading">
								<i class="fas fa-lightbulb me-1"></i>
								Recommendations
							</h6>
							<div id="recommendations">
								<small class="text-muted">Generating recommendations...</small>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
// Analytics page specific JavaScript
let currentChartType = 'line';

function changeChartType(type) {
	currentChartType = type;
	
	// Update button states
	document.querySelectorAll('.btn-group .btn').forEach(btn => {
		btn.classList.remove('active');
	});
	event.target.classList.add('active');
	
	// Refresh chart with new type
	refreshAnalytics();
}

function exportAnalytics() {
	// Export analytics data
	console.log('Exporting analytics data...');
}

function refreshAnalytics() {
	// Add loading state to all charts
	document.querySelectorAll('.chart-container').forEach(container => {
		container.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary" role="status"></div></div>';
	});
	
	// Refresh data after a short delay
	setTimeout(() => {
		// Trigger chart refresh
		if (window.chartAttempts) {
			window.chartAttempts.destroy();
		}
		// Re-render charts with new data
		renderCharts();
	}, 1000);
}

// Update KPIs with real data
function updateAnalyticsKPIs(data) {
	const aggregates = data;
	
	// Calculate attack rate (attacks per hour)
	const totalAttacks = aggregates.attempts_over_time?.reduce((sum, item) => sum + item.count, 0) || 0;
	const hours = aggregates.attempts_over_time?.length || 1;
	const attackRate = Math.round(totalAttacks / hours);
	document.getElementById('attack-rate').textContent = attackRate;
	
	// Update geographic spread (mock data for now)
	document.getElementById('geographic-spread').textContent = '15';
	
	// Update threat level
	const threatLevel = Math.min(100, Math.floor((totalAttacks / 1000) * 100));
	document.getElementById('threat-level').textContent = threatLevel + '%';
	
	// Update detection rate
	document.getElementById('detection-rate').textContent = '99.8%';
}

// Initialize analytics page
document.addEventListener('DOMContentLoaded', function() {
	// Add animation delays to cards
	document.querySelectorAll('.card').forEach((card, index) => {
		card.style.animationDelay = `${index * 0.1}s`;
	});
	
	// Initialize chart type buttons
	document.querySelectorAll('.btn-group .btn').forEach(btn => {
		btn.addEventListener('click', function() {
			document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
			this.classList.add('active');
		});
	});
});
</script>
{% endblock %}

