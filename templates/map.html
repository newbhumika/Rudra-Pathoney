{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-end gap-2 mb-3">
	<div>
		<label class="form-label">Since</label>
		<select class="form-select form-select-sm" id="map-hours">
			<option value="24" selected>Last 24h</option>
			<option value="1">Last 1h</option>
			<option value="6">Last 6h</option>
			<option value="168">Last 7d</option>
			<option value="720">Last 30d</option>
			<option value="">All</option>
		</select>
	</div>
	<button class="btn btn-primary btn-sm" id="refresh-map">Refresh</button>
</div>

<div class="alert alert-info mb-3">
	<strong>Note:</strong> The map shows geolocated attacker IPs. Private IPs (192.168.x.x, 172.16-31.x.x, 10.x.x.x) cannot be mapped. 
	<br>Check the console for debug info about IP geolocation.
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<div id="map" style="height:60vh" class="rounded border border-secondary"></div>

<div id="map-status" class="mt-3"></div>

<script>
(function(){
	const map = L.map('map').setView([20, 0], 2);
	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
	let markers = [];
	
	function clearMarkers(){ 
		markers.forEach(m=>map.removeLayer(m)); 
		markers = []; 
	}
	
	function updateStatus(message, type = 'info') {
		const statusEl = document.getElementById('map-status');
		statusEl.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
	}
	
	function refresh(){
		const hours = document.getElementById('map-hours').value;
		const url = '/api/geo/top_ips' + (hours? ('?since_hours='+hours) : '');
		
		updateStatus('Loading IP locations...', 'info');
		console.log('Fetching from:', url);
		
		fetch(url).then(r=>r.json()).then(json => {
			console.log('API response:', json);
			clearMarkers();
			
			const data = json.data || [];
			if (data.length === 0) {
				updateStatus('No geolocated IPs found. This usually means:<br>1. No logs in database yet<br>2. All IPs are private (192.168.x.x, 172.x.x.x, 10.x.x.x)<br>3. No successful geolocation from ipinfo.io', 'warning');
				return;
			}
			
			let mappedCount = 0;
			data.forEach(item => {
				if(item.lat && item.lon){
					const marker = L.marker([item.lat, item.lon]).addTo(map);
					marker.bindPopup(`<b>${item.ip}</b><br>${item.city||''} ${item.region||''} ${item.country||''}`);
					markers.push(marker);
					mappedCount++;
				}
			});
			
			if (mappedCount > 0) {
				updateStatus(`Mapped ${mappedCount} IP locations successfully!`, 'success');
			} else {
				updateStatus('No valid coordinates found in the data', 'warning');
			}
		}).catch(e => {
			console.error('Map error:', e);
			updateStatus(`Error loading map data: ${e.message}`, 'danger');
		});
	}
	
	document.getElementById('refresh-map').addEventListener('click', refresh);
	refresh();
})();
</script>
{% endblock %}
