{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-end gap-2 mb-3">
	<div>
		<label class="form-label">Since</label>
		<select class="form-select form-select-sm" id="insights-hours">
			<option value="24" selected>Last 24h</option>
			<option value="1">Last 1h</option>
			<option value="6">Last 6h</option>
			<option value="168">Last 7d</option>
			<option value="720">Last 30d</option>
			<option value="">All</option>
		</select>
	</div>
	<button class="btn btn-primary btn-sm" id="refresh-insights">Analyze</button>
</div>

<div class="card bg-secondary-subtle shadow-sm">
	<div class="card-body">
		<h5 class="card-title">AI Insights</h5>
		<pre id="insights" class="mt-3 text-light" style="white-space:pre-wrap"></pre>
	</div>
</div>

<script>
(function(){
	function qs(id){ return document.getElementById(id); }
	function render(obj){
		if(typeof obj === 'string') { qs('insights').textContent = obj; return; }
		let out = '';
		if(obj.summary){ out += 'Summary:\n' + obj.summary + '\n\n'; }
		if(Array.isArray(obj.findings) && obj.findings.length){ out += 'Findings:\n- ' + obj.findings.join('\n- ') + '\n\n'; }
		if(Array.isArray(obj.mitre) && obj.mitre.length){ out += 'MITRE ATT&CK:\n- ' + obj.mitre.join('\n- ') + '\n\n'; }
		if(Array.isArray(obj.recommendations) && obj.recommendations.length){ out += 'Recommendations:\n- ' + obj.recommendations.join('\n- ') + '\n'; }
		qs('insights').textContent = out || JSON.stringify(obj, null, 2);
	}
	function refresh(){
		const hours = qs('insights-hours').value;
		const url = '/api/insights' + (hours? ('?since_hours='+hours) : '');
		qs('insights').textContent = 'Analyzing...';
		fetch(url).then(r=>r.json()).then(render).catch(e=>{ qs('insights').textContent = String(e); });
	}
	qs('refresh-insights').addEventListener('click', refresh);
	refresh();
})();
</script>
{% endblock %}
