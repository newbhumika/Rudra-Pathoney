{% extends 'base.html' %}
{% block content %}
<!-- Header Section -->
<div class="row mb-4">
	<div class="col-12">
		<div class="d-flex justify-content-between align-items-center">
			<div>
				<h1 class="text-gradient mb-2">
					<i class="fas fa-brain text-warning me-2"></i>
					AI Security Insights
				</h1>
				<p class="text-muted mb-0">Advanced AI-powered threat analysis and security recommendations</p>
			</div>
			<div class="d-flex align-items-center gap-3">
				<div class="dropdown">
					<select class="form-select" id="insights-hours">
						<option value="1">Last 1 hour</option>
						<option value="6">Last 6 hours</option>
						<option value="24" selected>Last 24 hours</option>
						<option value="168">Last 7 days</option>
						<option value="720">Last 30 days</option>
						<option value="">All time</option>
					</select>
				</div>
				<button class="btn btn-primary" id="refresh-insights">
					<i class="fas fa-magic me-1"></i>Analyze
				</button>
				<button class="btn btn-outline-secondary" onclick="exportInsights()">
					<i class="fas fa-download me-1"></i>Export
				</button>
			</div>
		</div>
	</div>
</div>

<!-- AI Analysis Status -->
<div class="row g-3 mb-4">
	<div class="col-12 col-md-3">
		<div class="card text-center animate-fade-in">
			<div class="card-body">
				<i class="fas fa-robot text-primary fa-2x mb-2"></i>
				<h4 class="text-primary mb-1" id="ai-status">Ready</h4>
				<small class="text-muted">AI Engine</small>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.1s;">
			<div class="card-body">
				<i class="fas fa-clock text-info fa-2x mb-2"></i>
				<h4 class="text-info mb-1" id="analysis-time">--</h4>
				<small class="text-muted">Analysis Time</small>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.2s;">
			<div class="card-body">
				<i class="fas fa-shield-alt text-success fa-2x mb-2"></i>
				<h4 class="text-success mb-1" id="threat-level">--</h4>
				<small class="text-muted">Threat Level</small>
			</div>
		</div>
	</div>
	<div class="col-12 col-md-3">
		<div class="card text-center animate-fade-in" style="animation-delay: 0.3s;">
			<div class="card-body">
				<i class="fas fa-lightbulb text-warning fa-2x mb-2"></i>
				<h4 class="text-warning mb-1" id="recommendations-count">--</h4>
				<small class="text-muted">Recommendations</small>
			</div>
		</div>
	</div>
</div>

<!-- AI Insights Results -->
<div class="row g-4">
	<div class="col-12">
		<div class="card animate-fade-in" style="animation-delay: 0.4s;">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h5 class="mb-0">
					<i class="fas fa-brain text-warning me-2"></i>
					AI Security Analysis
				</h5>
				<div class="d-flex gap-2">
					<button class="btn btn-sm btn-outline-secondary" onclick="copyInsights()">
						<i class="fas fa-copy me-1"></i>Copy
					</button>
					<button class="btn btn-sm btn-outline-secondary" onclick="printInsights()">
						<i class="fas fa-print me-1"></i>Print
					</button>
				</div>
			</div>
			<div class="card-body">
				<div id="insights-container">
					<div class="text-center py-5">
						<div class="spinner-border text-primary mb-3" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<p class="text-muted">Initializing AI analysis...</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
	<div class="col-12">
		<div class="card animate-fade-in" style="animation-delay: 0.5s;">
			<div class="card-header">
				<h5 class="mb-0">
					<i class="fas fa-bolt text-warning me-2"></i>
					Quick Actions
				</h5>
			</div>
			<div class="card-body">
				<div class="row g-3">
					<div class="col-12 col-md-6 col-lg-3">
						<button class="btn btn-outline-primary w-100" onclick="analyzeThreats()">
							<i class="fas fa-search me-2"></i>Threat Analysis
						</button>
					</div>
					<div class="col-12 col-md-6 col-lg-3">
						<button class="btn btn-outline-info w-100" onclick="generateReport()">
							<i class="fas fa-file-alt me-2"></i>Generate Report
						</button>
					</div>
					<div class="col-12 col-md-6 col-lg-3">
						<button class="btn btn-outline-success w-100" onclick="viewRecommendations()">
							<i class="fas fa-lightbulb me-2"></i>View Recommendations
						</button>
					</div>
					<div class="col-12 col-md-6 col-lg-3">
						<button class="btn btn-outline-warning w-100" onclick="scheduleAnalysis()">
							<i class="fas fa-clock me-2"></i>Schedule Analysis
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
(function(){
	'use strict';
	
	function qs(id){ return document.getElementById(id); }
	
	// Enhanced AI insights rendering
	function renderInsights(obj){
		const container = qs('insights-container');
		
		if(typeof obj === 'string') { 
			container.innerHTML = `<div class="alert alert-info"><pre class="mb-0">${obj}</pre></div>`;
			return; 
		}
		
		let html = '';
		
		// Summary Section
		if(obj.summary) {
			html += `
				<div class="mb-4">
					<h6 class="text-primary mb-3">
						<i class="fas fa-clipboard-list me-2"></i>Executive Summary
					</h6>
					<div class="alert alert-info">
						<p class="mb-0">${obj.summary}</p>
					</div>
				</div>
			`;
		}
		
		// Findings Section
		if(Array.isArray(obj.findings) && obj.findings.length) {
			html += `
				<div class="mb-4">
					<h6 class="text-warning mb-3">
						<i class="fas fa-exclamation-triangle me-2"></i>Key Findings
					</h6>
					<div class="row g-3">
			`;
			obj.findings.forEach((finding, index) => {
				html += `
					<div class="col-12 col-md-6">
						<div class="alert alert-warning">
							<div class="d-flex">
								<div class="flex-shrink-0">
									<i class="fas fa-circle text-warning"></i>
								</div>
								<div class="flex-grow-1 ms-2">
									<small>${finding}</small>
								</div>
							</div>
						</div>
					</div>
				`;
			});
			html += `</div></div>`;
		}
		
		// MITRE ATT&CK Section
		if(Array.isArray(obj.mitre) && obj.mitre.length) {
			html += `
				<div class="mb-4">
					<h6 class="text-danger mb-3">
						<i class="fas fa-crosshairs me-2"></i>MITRE ATT&CK Framework
					</h6>
					<div class="row g-2">
			`;
			obj.mitre.forEach(technique => {
				html += `
					<div class="col-12 col-md-6 col-lg-4">
						<span class="badge bg-danger">${technique}</span>
					</div>
				`;
			});
			html += `</div></div>`;
		}
		
		// Recommendations Section
		if(Array.isArray(obj.recommendations) && obj.recommendations.length) {
			html += `
				<div class="mb-4">
					<h6 class="text-success mb-3">
						<i class="fas fa-lightbulb me-2"></i>Security Recommendations
					</h6>
					<div class="list-group">
			`;
			obj.recommendations.forEach((rec, index) => {
				html += `
					<div class="list-group-item bg-transparent border-secondary">
						<div class="d-flex">
							<div class="flex-shrink-0">
								<span class="badge bg-success me-2">${index + 1}</span>
							</div>
							<div class="flex-grow-1">
								<small>${rec}</small>
							</div>
						</div>
					</div>
				`;
			});
			html += `</div></div>`;
		}
		
		// Firewall Rules Section
		if(Array.isArray(obj.firewall_rules) && obj.firewall_rules.length) {
			html += `
				<div class="mb-4">
					<h6 class="text-info mb-3">
						<i class="fas fa-shield-alt me-2"></i>Recommended Firewall Rules
					</h6>
					<div class="alert alert-info">
						<pre class="mb-0"><code>${obj.firewall_rules.join('\n')}</code></pre>
					</div>
				</div>
			`;
		}
		
		// Fallback for raw JSON
		if(!html) {
			html = `<div class="alert alert-secondary"><pre class="mb-0">${JSON.stringify(obj, null, 2)}</pre></div>`;
		}
		
		container.innerHTML = html;
		
		// Update stats
		updateInsightStats(obj);
	}
	
	function updateInsightStats(obj) {
		// Update threat level
		const threatLevel = obj.summary?.toLowerCase().includes('critical') ? 'Critical' :
						   obj.summary?.toLowerCase().includes('high') ? 'High' :
						   obj.summary?.toLowerCase().includes('medium') ? 'Medium' : 'Low';
		qs('threat-level').textContent = threatLevel;
		qs('threat-level').className = `text-${threatLevel === 'Critical' ? 'danger' : threatLevel === 'High' ? 'warning' : threatLevel === 'Medium' ? 'info' : 'success'} mb-1`;
		
		// Update recommendations count
		const recCount = Array.isArray(obj.recommendations) ? obj.recommendations.length : 0;
		qs('recommendations-count').textContent = recCount;
		
		// Update analysis time
		qs('analysis-time').textContent = new Date().toLocaleTimeString();
	}
	
	async function refreshInsights(){
		const hours = qs('insights-hours').value;
		const url = '/api/insights' + (hours ? ('?since_hours=' + hours) : '');
		
		// Show loading state
		qs('insights-container').innerHTML = `
			<div class="text-center py-5">
				<div class="spinner-border text-primary mb-3" role="status">
					<span class="visually-hidden">Analyzing...</span>
				</div>
				<p class="text-muted">AI is analyzing security data...</p>
				<small class="text-muted">This may take a few moments</small>
			</div>
		`;
		
		qs('ai-status').textContent = 'Analyzing';
		qs('ai-status').className = 'text-warning mb-1';
		
		try {
			const response = await fetch(url);
			const data = await response.json();
			
			if (data.error) {
				throw new Error(data.error);
			}
			
			renderInsights(data);
			qs('ai-status').textContent = 'Complete';
			qs('ai-status').className = 'text-success mb-1';
			
			// Show success notification
			if (typeof showNotification === 'function') {
				showNotification('AI analysis completed successfully', 'success', 3000);
			}
			
		} catch (error) {
			console.error('Insights error:', error);
			qs('insights-container').innerHTML = `
				<div class="alert alert-danger">
					<h6 class="alert-heading">
						<i class="fas fa-exclamation-triangle me-2"></i>Analysis Error
					</h6>
					<p class="mb-0">${error.message}</p>
				</div>
			`;
			qs('ai-status').textContent = 'Error';
			qs('ai-status').className = 'text-danger mb-1';
		}
	}
	
	// Global functions
	window.exportInsights = function() {
		const content = qs('insights-container').innerText;
		const blob = new Blob([content], { type: 'text/plain' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = `security-insights-${new Date().toISOString().split('T')[0]}.txt`;
		a.click();
		URL.revokeObjectURL(url);
	};
	
	window.copyInsights = function() {
		const content = qs('insights-container').innerText;
		navigator.clipboard.writeText(content).then(() => {
			if (typeof showNotification === 'function') {
				showNotification('Insights copied to clipboard', 'success', 2000);
			}
		});
	};
	
	window.printInsights = function() {
		const content = qs('insights-container').innerHTML;
		const printWindow = window.open('', '_blank');
		printWindow.document.write(`
			<html>
				<head><title>Security Insights Report</title></head>
				<body>${content}</body>
			</html>
		`);
		printWindow.document.close();
		printWindow.print();
	};
	
	window.analyzeThreats = function() {
		window.location.href = '/threat-hunting';
	};
	
	window.generateReport = function() {
		exportInsights();
	};
	
	window.viewRecommendations = function() {
		const recommendations = document.querySelector('.text-success');
		if (recommendations) {
			recommendations.scrollIntoView({ behavior: 'smooth' });
		}
	};
	
	window.scheduleAnalysis = function() {
		if (typeof showNotification === 'function') {
			showNotification('Scheduled analysis feature coming soon', 'info', 3000);
		}
	};
	
	// Event listeners
	qs('refresh-insights').addEventListener('click', refreshInsights);
	
	// Initial load
	refreshInsights();
	
	// Auto-refresh every 5 minutes
	setInterval(refreshInsights, 300000);
})();
</script>
{% endblock %}

